# HMA Compliance Stack - Wazuh Custom Rules
# Custom detection rules for HMA-specific security events

# Docker Container Security Rules
# Detects suspicious Docker container activities

<group name="hma_docker,">
  
  <!-- Container with root privileges -->
  <rule id="100001" level="7">
    <if_sid>87900</if_sid>
    <match>privileged</match>
    <description>Docker container started with privileged mode</description>
    <group>docker,pci_dss_10.6.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,</group>
  </rule>

  <!-- Host network mode usage -->
  <rule id="100002" level="6">
    <if_sid>87900</if_sid>
    <match>host network</match>
    <description>Docker container using host network mode</description>
    <group>docker,pci_dss_2.2.4,gdpr_IV_35.7.d,nist_800_53_CM.7,tsc_CC6.6,</group>
  </rule>

  <!-- Sensitive mount points -->
  <rule id="100003" level="8">
    <if_sid>87900</if_sid>
    <regex>/var/run/docker.sock|/etc/shadow|/etc/passwd</regex>
    <description>Docker container mounting sensitive host paths</description>
    <group>docker,pci_dss_2.2.4,gdpr_IV_35.7.d,hipaa_164.312.a.1,nist_800_53_AC.3,tsc_CC6.1,</group>
  </rule>

</group>

# HMA Application Security Rules
# Detects security events in HMA Academy application

<group name="hma_application,">

  <!-- Failed admin login attempts -->
  <rule id="100010" level="5">
    <if_group>authentication_failed</if_group>
    <match>/api/admin</match>
    <description>Failed admin portal login attempt</description>
    <group>authentication_failures,pci_dss_10.2.4,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,tsc_CC6.1,</group>
  </rule>

  <!-- Multiple failed admin logins (brute force) -->
  <rule id="100011" level="10" frequency="5" timeframe="300">
    <if_matched_sid>100010</if_matched_sid>
    <description>Multiple failed admin login attempts - Possible brute force</description>
    <group>authentication_failures,pci_dss_11.4,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Unauthorized API access attempts -->
  <rule id="100012" level="7">
    <match>401 Unauthorized|403 Forbidden</match>
    <regex>/api/(admin|subscription|payment)</regex>
    <description>Unauthorized access attempt to protected API endpoint</description>
    <group>access_denied,pci_dss_10.2.4,gdpr_IV_32.2,nist_800_53_AU.14,tsc_CC6.1,</group>
  </rule>

  <!-- SQL injection attempts -->
  <rule id="100013" level="10">
    <regex>UNION SELECT|DROP TABLE|INSERT INTO|DELETE FROM</regex>
    <description>Possible SQL injection attack detected</description>
    <group>attacks,sql_injection,pci_dss_6.5.1,gdpr_IV_32.2,hipaa_164.312.a.1,nist_800_53_SI.4,tsc_CC7.1,</group>
  </rule>

  <!-- XSS attempts -->
  <rule id="100014" level="9">
    <regex><script|javascript:|onerror=|onload=</regex>
    <description>Possible XSS attack detected</description>
    <group>attacks,xss,pci_dss_6.5.7,gdpr_IV_32.2,nist_800_53_SI.4,tsc_CC7.1,</group>
  </rule>

</group>

# Database Security Rules
# PostgreSQL audit and security monitoring

<group name="hma_database,">

  <!-- Unauthorized database access -->
  <rule id="100020" level="8">
    <if_sid>50400</if_sid>
    <match>authentication failed</match>
    <description>PostgreSQL authentication failure</description>
    <group>authentication_failed,pci_dss_10.2.4,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,tsc_CC6.1,</group>
  </rule>

  <!-- Sensitive table access -->
  <rule id="100021" level="6">
    <if_sid>50500</if_sid>
    <regex>users|subscriptions|payment_methods|transactions</regex>
    <description>Access to sensitive database table</description>
    <group>database_access,pci_dss_10.2.2,gdpr_IV_32.2,hipaa_164.312.a.1,nist_800_53_AU.12,tsc_CC6.2,</group>
  </rule>

  <!-- Database schema changes -->
  <rule id="100022" level="9">
    <if_sid>50500</if_sid>
    <regex>ALTER TABLE|DROP TABLE|CREATE TABLE|TRUNCATE</regex>
    <description>Database schema modification detected</description>
    <group>database_schema,pci_dss_10.2.7,gdpr_IV_32.2,nist_800_53_CM.3,tsc_CC8.1,</group>
  </rule>

</group>

# File Integrity Monitoring Rules
# Critical file changes in HMA application

<group name="hma_fim,">

  <!-- Configuration file changes -->
  <rule id="100030" level="7">
    <if_sid>550</if_sid>
    <regex>\.env|config\.js|settings\.py</regex>
    <description>Critical configuration file modified</description>
    <group>file_integrity,pci_dss_11.5,gdpr_IV_32.2,hipaa_164.312.c.1,nist_800_53_SI.7,tsc_CC7.2,</group>
  </rule>

  <!-- SSL/TLS certificate changes -->
  <rule id="100031" level="8">
    <if_sid>550</if_sid>
    <regex>\.pem|\.crt|\.key</regex>
    <description>SSL/TLS certificate or key file modified</description>
    <group>file_integrity,pci_dss_4.1,gdpr_IV_32.2,hipaa_164.312.e.1,nist_800_53_SC.8,tsc_CC6.7,</group>
  </rule>

  <!-- Unauthorized code deployment -->
  <rule id="100032" level="10">
    <if_sid>554</if_sid>
    <regex>/app/|/var/www/</regex>
    <description>Unauthorized file creation in application directory</description>
    <group>file_integrity,pci_dss_11.5,gdpr_IV_35.7.d,nist_800_53_SI.7,tsc_CC7.2,</group>
  </rule>

</group>

# Compliance-Specific Rules
# ISO 27001, SOC 2, GDPR, CCPA event detection

<group name="hma_compliance,">

  <!-- User data access (GDPR/CCPA) -->
  <rule id="100040" level="3">
    <match>user_data_access</match>
    <description>User personal data accessed - GDPR/CCPA logging</description>
    <group>data_privacy,gdpr_IV_30,ccpa_1798.100,nist_800_53_AU.2,tsc_CC6.2,</group>
  </rule>

  <!-- Data export (GDPR Right to Portability) -->
  <rule id="100041" level="5">
    <match>data_export_requested</match>
    <description>User data export requested - GDPR Article 20</description>
    <group>data_privacy,gdpr_IV_20,ccpa_1798.110,nist_800_53_PM.9,tsc_P3.2,</group>
  </rule>

  <!-- Data deletion (GDPR Right to Erasure) -->
  <rule id="100042" level="6">
    <match>account_deletion_requested</match>
    <description>User account deletion requested - GDPR Article 17</description>
    <group>data_privacy,gdpr_IV_17,ccpa_1798.105,nist_800_53_PM.9,tsc_P4.2,</group>
  </rule>

  <!-- PCI-DSS: Payment card data access -->
  <rule id="100043" level="8">
    <regex>payment_methods|card_number|cvv</regex>
    <description>Payment card data accessed - PCI-DSS monitoring</description>
    <group>pci_dss,pci_dss_3.2,pci_dss_10.2.2,nist_800_53_AU.12,tsc_CC6.1,</group>
  </rule>

  <!-- SOC 2: Availability monitoring -->
  <rule id="100044" level="6">
    <match>service_unavailable|500 Internal|503 Service</match>
    <description>Service availability issue - SOC 2 monitoring</description>
    <group>availability,tsc_A1.2,nist_800_53_CP.2,</group>
  </rule>

</group>

# AWS CloudWatch Integration Rules
# Detect AWS security events

<group name="hma_aws,">

  <!-- AWS GuardDuty findings -->
  <rule id="100050" level="9">
    <if_sid>80300</if_sid>
    <match>GuardDuty</match>
    <description>AWS GuardDuty security finding detected</description>
    <group>aws,cloud,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- AWS CloudTrail: Root account usage -->
  <rule id="100051" level="10">
    <if_sid>80200</if_sid>
    <match>Root|AssumeRole</match>
    <description>AWS root account activity detected</description>
    <group>aws,cloud,pci_dss_7.1,gdpr_IV_32.2,hipaa_164.312.a.1,nist_800_53_AC.2,tsc_CC6.1,</group>
  </rule>

  <!-- S3 bucket policy changes -->
  <rule id="100052" level="8">
    <if_sid>80200</if_sid>
    <regex>PutBucketPolicy|DeleteBucketPolicy</regex>
    <description>S3 bucket policy modified</description>
    <group>aws,cloud,pci_dss_10.2.7,gdpr_IV_32.2,nist_800_53_CM.3,tsc_CC6.6,</group>
  </rule>

</group>
